<!-- templates/listar_pendentes.html -->
{% extends "layout.html" %}

{% block title %}Listar Transações Pendentes{% endblock %}

{% block content %}
<script src="../static/js/formatarValor.js"></script>
<div class="container mt-5">
    <h2>Filtrar Transações Pendentes</h2>
    <form method="POST" action="{{ url_for('adm_lista_paymments_pendentes') }}">
        <div class="form-group">
            <label for="ano">Ano</label>
            <select class="form-control" id="ano" name="ano">
                <option value="2023" {% if ano=='2023' %}selected{% endif %}>2023</option>
                <option value="2024" {% if ano=='2024' %}selected{% endif %}>2024</option>
                <option value="2025" {% if ano=='2025' %}selected{% endif %}>2025</option>
            </select>
        </div>
        <div class="form-group">
            <label for="mes">Mês</label>
            <select class="form-control" id="mes" name="mes">
                <option value="01" {% if mes=='01' %}selected{% endif %}>Janeiro</option>
                <option value="02" {% if mes=='02' %}selected{% endif %}>Fevereiro</option>
                <option value="03" {% if mes=='03' %}selected{% endif %}>Março</option>
                <option value="04" {% if mes=='04' %}selected{% endif %}>Abril</option>
                <option value="05" {% if mes=='05' %}selected{% endif %}>Maio</option>
                <option value="06" {% if mes=='06' %}selected{% endif %}>Junho</option>
                <option value="07" {% if mes=='07' %}selected{% endif %}>Julho</option>
                <option value="08" {% if mes=='08' %}selected{% endif %}>Agosto</option>
                <option value="09" {% if mes=='09' %}selected{% endif %}>Setembro</option>
                <option value="10" {% if mes=='10' %}selected{% endif %}>Outubro</option>
                <option value="11" {% if mes=='11' %}selected{% endif %}>Novembro</option>
                <option value="12" {% if mes=='12' %}selected{% endif %}>Dezembro</option>
            </select>
        </div>
        <div align="center">
            <button type="submit" class="btn btn-primary mt-3" style="width: 80%;">Filtrar</button>
        </div>
    </form>

    <h3 class="mt-5">Pagamento Pendente</h3>
    {% if transactions %}

    
        <table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>Nº OS</th>
            <th>Valor</th>
            <th>Método</th>
            <th>Vencimento</th>
            <th>Técnico</th>
            <th>Cidade</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody>
        {% for trans_data in transactions %}
        <tr>
            <td>
                <span class="badge bg-danger fs-6">
                    Nº {{ trans_data.get('numero_os', 'N/A') }}
                </span>
            </td>
            <td>R$ {{ trans_data.amount }}</td>
            <td>{{ trans_data.method }}</td>
            <td>{{ trans_data.vencimento }}</td>
            <td>{{ trans_data.name_tecnico }}</td>
            <td>{{ trans_data.os_city }}</td>
            <td>
                {% set year, month, day = trans_data.os_date.split('-') %}
                <a class="btn btn-primary btn-sm" 
                   href="/os/{{trans_data.os_city}}/{{year}}/{{month}}/{{day}}/{{trans_data.os_id}}">
                   Ver OS
                </a>
                <button type="button" id="buttonconfirmarpaymment" 
                        class="btn btn-success btn-sm" 
                        data-toggle="modal" 
                        data-target="#confirmarpaymment"
                        data-transactionid="{{ trans_data.transaction_id }}" 
                        data-osdate="{{ trans_data.os_date }}" 
                        data-vencimento="{{ trans_data.vencimento }}" 
                        data-idos="{{ trans_data.os_id }}" 
                        data-city="{{ trans_data.os_city }}" 
                        data-nametecnicoos="{{trans_data.name_tecnico}}" 
                        data-numeroos="{{trans_data.numero_os}}">
                        Confirmar
                </button>
                <button
                  class="btn btn-danger btn-sm btn-cancelar"
                  data-mes="{{ mes }}"
                  data-ano="{{ ano }}"
                  data-id-transaction="{{ trans_data.transaction_id }}"
                  data-date-os="{{trans_data.os_date}}"
                  data-id-os="{{trans_data.os_id}}"
                  data-city="{{ trans_data.os_city }}"
                >
                  Cancelar
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
    <!-- Modal para gerar OS -->
    <div class="modal fade" id="confirmarpaymment" tabindex="-1" role="dialog" aria-labelledby="paymmentModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymmentModalLabel">Confirmar Pagamento</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="paymmentPenddingForm" method="post" action="/update_pendding">
                        <input id="paymmentIdOs" name="paymmentIdOs" hidden>
                        <input id="paymmentCity" name="paymmentCity" hidden>
                        <input id="osnametecnico" name="osnametecnico" hidden>
                        <input id="osDate" name="osDate" hidden>
                        <input id="transactionId" name="transactionId" hidden>
                        <input id="numeroos" name="numeroos" hidden>
                        <div class="form-group">
                            <label for="paymentDate" style="font-size: small;">Data</label>
                            <input type="date" class="form-control" id="osDatePaymment" name="datePaymment" required>
                        </div>

                        <div class="form-group">
                            <label for="amount" style="font-size: small;">Valor Recebido (R$)</label>
                            <input type="tel" class="form-control" id="osAmount" name="amountAtualizado" value="0,00" required>
                        </div>
                        <div>
                            <label for="taxa-service">Taxa</label>
                            <input
                                type="tel"
                                class="form-control"
                                id="taxa"
                                name="taxa"
                                placeholder="Insira o valor"
                            />
                        </div>
                        <div class="mt-4 p-2" style="background-color: rgb(255, 240, 240)">
                        <div>
                            <label for="outros-custos-service"
                            ><strong>Custos do Serviço </strong></label
                            >
                            <input
                            type="tel"
                            class="form-control"
                            id="outros-custos-service"
                            name="outrosCustosService"
                            placeholder="Insira o valor"
                            />
                        </div>
                        <div class="form-group mt-3">
                            <label for="observacao-service"><strong>Observação</strong></label>
                            <input
                            type="text"
                            class="form-control"
                            id="observacao-service"
                            name="observacaoService"
                            placeholder="Insira uma observação"
                            />
                        </div>
                        </div>
                        <div align="center">
                            <button type="submit" id="confirmaros" class="btn btn-primary" style="width: 80%;">Confirmar Pagamento</button>
                        </div>
    
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Overlay para bloquear a tela de fundo -->
    <div class="overlay" id="overlay"></div>

    <!-- Pop-up -->
    <div class="popup" id="popup" align="center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div>
        <span>Salvando...</span>
      </div>
    </div>
    {% else %}
    <p>Nenhuma transação pendente encontrada.</p>
    {% endif %}


    <script>
        const toNum = (v) => parseFloat(String(v).replace(",", "."));

        document.getElementById("paymmentPenddingForm").addEventListener("submit", function (e) {
        const outrosCustosService = document.getElementById("outros-custos-service").value.trim();
        const observacaoService = document.getElementById("observacao-service").value.trim();

        if (toNum(outrosCustosService) > 0 && !observacaoService) {
        e.preventDefault(); // impede envio do form
        alert("Informe detalhes dos custos no campo OBSERVAÇÃO.");
        document.getElementById("observacao-service").focus();
        }
    });
</script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Script -->
    <script>
        // Preencher os dados do modal quando o botão é clicado
        $('#confirmarpaymment').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // Botão que acionou o modal
            var idOs = button.data('idos');
            var city = button.data('city');
            var osdate = button.data('osdate');
            var vencimento = button.data('vencimento'); 
            var transactionId = button.data('transactionid');
            var osnametecnico = button.data('nametecnicoos');
            var numeroos = button.data('numeroos');

            var modal = $(this);
            modal.find('#paymmentIdOs').val(idOs);
            modal.find('#paymmentCity').val(city);
            modal.find('#paymmentVencimento').val(vencimento);
            modal.find('#osDate').val(osdate);
            modal.find('#transactionId').val(transactionId);
            modal.find('#osnametecnico').val(osnametecnico);
            modal.find('#numeroos').val(numeroos);

        });
    </script>
    <script>
      function mostrarPopup() {
        var overlay = document.getElementById("overlay");
        var popup = document.getElementById("popup");

        overlay.style.display = "block";
        popup.style.display = "block";

        // Bloqueia a interação com a tela de fundo
        overlay.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
        });
      }
    </script>
    <!--<script>
        const inputValor = document.getElementById('osAmount');

        inputValor.addEventListener('input', formatarValor);

        function formatarValor() {
            // Remove qualquer caracter que não seja um dígito numérico
            let valor = inputValor.value.replace(/\D/g, '');

            // Divide o valor em duas partes: a parte inteira e a parte decimal
            const parteInteira = valor.slice(0, -2);
            const parteDecimal = valor.slice(-2);

            // Adiciona um ponto para separar os milhares
            const parteInteiraFormatada = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

            // Atualiza o valor do input com a string formatada como um valor em reais (R$)
            inputValor.value = `${parteInteiraFormatada},${parteDecimal}`;
        }
    </script>-->
    <script>
            document.addEventListener("DOMContentLoaded", function () {
                configurarFormatacaoValor("osAmount");
                configurarFormatacaoValor("taxa");
                configurarFormatacaoValor("outros-custos-service");
            });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // Usando Luxon para lidar com o fuso horário
            const DateTime = luxon.DateTime;

            // Obtenha a data atual no fuso horário de São Paulo
            const nowInSaoPaulo = DateTime.now().setZone('America/Sao_Paulo');

            // Formate a data para 'YYYY-MM-DD'
            const formattedDate = nowInSaoPaulo.toFormat('yyyy-MM-dd');

            // Obtenha o elemento de entrada da data
            const dateInput = document.getElementById('osDatePaymment');

            // Defina o valor do campo de data para a data atual em São Paulo
            dateInput.value = formattedDate;
        });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const deleteButtons = document.querySelectorAll(".btn-cancelar");


        deleteButtons.forEach((btn) => {
          btn.addEventListener("click", function () {
            const dataMes = this.getAttribute("data-mes");
            const dataAno = this.getAttribute("data-ano");
            const idTransaction = this.getAttribute("data-id-transaction");
            const dateOs = this.getAttribute("data-date-os");
            const idOs = this.getAttribute("data-id-os");
            const city = this.getAttribute("data-city");


            if (confirm("Deseja realmente deletar esta transação?")) {
              mostrarPopup();
              fetch("/cancel_transaction_pendding", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    dataMes: dataMes,
                    dataAno: dataAno,
                    idTransaction: idTransaction,
                    dateOs: dateOs,
                    idOs: idOs,
                    city: city,

                }),
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.success) {
                    alert("Transação deletada com sucesso!");
                    window.location.reload(); // Atualiza tabela
                  } else {
                    alert("Erro ao deletar: " + data.message);
                  }
                })
                .catch((error) => {
                  console.error("Erro:", error);
                })
                .finally(() => {
              window.location.reload();
            });
            }
          });
        });
      });
    </script>
</div>
{% endblock %}