{% extends "layout.html" %} {% block title %}Dashboard{% endblock %} {% block
content %}
<script src="../static/js/formatarValor.js"></script>

<style>
  /* Cabe√ßalho */
  .cabecalho-agenda {
    background: white;
    padding: 25px 20px;
    border-radius: 14px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    margin-top: 30px;
    margin-bottom: 30px;
  }

  .cabecalho-agenda h1 {
    color: #0d5590;
    font-weight: 800;
    margin-bottom: 10px;
  }
  .cabecalho-agenda h3 {
    color: #0d5590;
    font-weight: 600;
    margin-bottom: 0;
  }

  /* Cards dos registros */
  .card-atendimento {
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.07);
    border: none;
    background: white;
  }

  .card-atendimento .card-title {
    color: #0d5590;
    font-weight: bold;
    font-size: 20px;
  }

  .card-atendimento .list-group-item {
    font-size: 15px;
    padding: 10px 15px;
  }

  /* √Årea do status */
  .status-label {
    font-size: 14px;
    margin-top: 8px;
    font-weight: 600;
    color: #444;
  }

  /* Bot√µes de OS */
  .btn-info,
  .btn-warning,
  .btn-danger {
    font-weight: bold;
    padding: 10px 14px;
    border-radius: 12px;
  }

  .btn-info {
    background: #0d5590;
    border: none;
  }
  .btn-info:hover {
    background: #083a63;
  }

  .btn-warning {
    color: #000;
    font-weight: 700;
  }

  .btn-danger {
    background: #c12525;
    border: none;
  }
  .btn-danger:hover {
    background: #8f1c1c;
  }

  /* Fundo escurecido */
  .modal-backdrop.show {
    opacity: 0.45 !important;
  }

  /* Caixa do modal */
  .modal-content {
    border-radius: 18px;
    border: none;
    overflow: hidden;
    box-shadow: 0 10px 35px rgba(0, 0, 0, 0.18);
  }

  /* Cabe√ßalho */
  .modal-header {
    background: linear-gradient(135deg, #0d5590, #083a63);
    color: #fff;
    padding: 18px 24px;
  }

  .modal-title {
    font-weight: 700;
    font-size: 1.3rem;
  }

  .modal-header .btn-close,
  .modal-header .close span {
    filter: brightness(200%) invert(1);
  }

  /* Corpo */
  .modal-body {
    background: #f7f9fb;
    padding: 28px 22px;
  }

  .modal-body .form-group label {
    color: #0d5590;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .modal-body .form-control,
  .modal-body .form-select {
    border-radius: 12px;
    padding: 10px;
    border: 1px solid #ced4da;
    font-size: 0.98rem;
    transition: 0.2s ease-in-out;
  }

  .modal-body .form-control:focus,
  .modal-body .form-select:focus {
    border-color: #0d5590;
    box-shadow: 0 0 0 0.15rem rgba(13, 85, 144, 0.25);
  }

  /* Box do endere√ßo */
  .endereco-box {
    background-color: #e8ecef;
    border-radius: 14px;
    padding: 18px;
    margin-top: 15px;
    margin-bottom: 20px;
  }

  .endereco-box h5 {
    color: #0d5590;
    font-weight: 700;
    margin-bottom: 12px;
  }

  /* Bot√£o confirmar */
  .confirmar-os-btn {
    background: #0d5590 !important;
    border: none !important;
    padding: 14px;
    border-radius: 14px;
    font-weight: 700;
    font-size: 1.1rem;
    transition: 0.2s;
  }

  .confirmar-os-btn:hover {
    background: #083a63 !important;
    transform: translateY(-2px);
  }
</style>

<!-- Cabe√ßalho -->
<div class="cabecalho-agenda text-center">
  <h1>{{ city }}</h1>
  <h3>{{ date }}</h3>
</div>

{% if records %} {% for record_id, record in records.items() %}

<div class="card card-atendimento mb-4">
  <div class="card-body">
    <h5 class="card-title">{{ record.name }}</h5>

    <ul class="list-group list-group-flush">
      <li class="list-group-item">üìû Telefone: <b>{{ record.phone }}</b></li>
      <li class="list-group-item">üîß Servi√ßo: <b>{{ record.service }}</b></li>
      <li class="list-group-item">üí∞ Valor: <b>{{ record.price }}</b></li>
      <li class="list-group-item">
        üïí {{ record.timestamp | datetimeformat }}
      </li>
      <li class="list-group-item">üìù Obs.: {{ record.details }}</li>
    </ul>

    <div class="text-end status-label"><b>Status:</b> {{ record.status }}</div>
  </div>

  <div class="card-footer d-flex justify-content-between">
    <button
      type="button"
      class="btn btn-info"
      data-toggle="modal"
      data-target="#osModal"
      data-tipo="os"
      data-city="{{ city }}"
      data-name="{{ record.name }}"
      data-phone="{{ record.phone }}"
      data-service="{{ record.service }}"
      data-price="{{ record.price }}"
      data-idrecord="{{ record_id }}"
    >
      Gerar OS
    </button>

    <button
      type="button"
      class="btn btn-warning"
      data-toggle="modal"
      data-target="#osModal"
      data-tipo="retorno"
      data-city="{{ city }}"
      data-name="{{ record.name }}"
      data-phone="{{ record.phone }}"
      data-service="{{ record.service }}"
      data-price="{{ record.price }}"
      data-idrecord="{{ record_id }}"
    >
      Retorno
    </button>

    <button
      type="button"
      class="btn btn-danger"
      data-toggle="modal"
      data-target="#osModal"
      data-tipo="reparo"
      data-city="{{ city }}"
      data-name="{{ record.name }}"
      data-phone="{{ record.phone }}"
      data-service="{{ record.service }}"
      data-price="{{ record.price }}"
      data-idrecord="{{ record_id }}"
    >
      Reparo
    </button>
  </div>
</div>
{% endfor %}

<!-- Modal √öNICO para Gerar OS / Reparo / Retorno -->
<div
  class="modal fade"
  id="osModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="osModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <!-- HEADER -->
      <div class="modal-header">
        <h5 class="modal-title" id="osModalLabel">Gerar Ordem de Servi√ßo</h5>
        <button
          type="button"
          class="close btn-close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true"></span>
        </button>
      </div>

      <!-- BODY -->
      <div class="modal-body">
        <form id="osForm" method="post" action="/gerar_os">
          <input id="osIdRecord" name="idRecord" hidden />

          <!-- Cidade -->
          <div class="form-group mb-3">
            <label for="osCity">Cidade</label>
            <input
              type="text"
              class="form-control"
              id="osCity"
              name="city"
              readonly
            />
          </div>

          <!-- Nome -->
          <div class="form-group mb-3">
            <label for="osName">Cliente</label>
            <input
              type="text"
              class="form-control"
              id="osName"
              name="name"
              readonly
            />
          </div>
          <!-- CPF ou CNPJ -->
          <div class="form-group mb-3">
            <label for="osCPFCNPJ">CPF/CNPJ</label>
            <input
              type="text"
              class="form-control"
              id="osCPFCNPJ"
              name="cpfcnpj"
              oninput="formatarCpfCnpj(this)"
            />
          </div>
          <!-- Telefone -->
          <div class="form-group mb-3">
            <label for="osPhone">Telefone</label>
            <input
              type="text"
              class="form-control"
              id="osPhone"
              name="phone"
              readonly
            />
          </div>

          <!-- Servi√ßo -->
          <div class="form-group mb-3">
            <label for="osServico">Servi√ßo</label>
            <input
              type="text"
              class="form-control"
              id="osServico"
              name="service"
              readonly
            />
          </div>

          <!-- Valor -->
          <div class="form-group mb-3">
            <label for="osPrice">Valor</label>
            <input
              type="text"
              class="form-control"
              id="osPrice"
              name="price"
              readonly
            />
          </div>

          <!-- Valor Final -->
          <div class="form-group mb-3">
            <label for="osPriceFinal">Valor Final</label>
            <input
              type="text"
              class="form-control"
              id="osPriceFinal"
              name="priceservice"
              required
            />
          </div>

          <!-- Endere√ßo -->
          <div class="endereco-box mt-4">
            <h5>Endere√ßo</h5>

            <!--<div class="form-group mb-3">
              <label for="osCep">CEP</label>
              <input
                type="text"
                class="form-control"
                id="osCep"
                name="cep"
                maxlength="9"
                oninput="mascaraCep(this)"
                onblur="buscarCep(this.value)"
              />
            </div>-->

            <div class="form-group mb-3">
              <label for="osBairro">Bairro/Setor</label>
              <input
                type="text"
                class="form-control"
                id="osBairro"
                name="bairro"
              />
            </div>

            <div class="form-group mb-3">
              <label for="osRua">Rua</label>
              <input type="text" class="form-control" id="osRua" name="rua" />
            </div>

            <div class="form-group mb-3">
              <label for="osNumeroCasa">N¬∫</label>
              <input
                type="text"
                class="form-control"
                id="osNumeroCasa"
                name="numerocasa"
              />
            </div>

            <div class="form-group mb-3">
              <label for="osEnderecoComplemento">Complemento</label>
              <input
                type="text"
                class="form-control"
                id="osEnderecoComplemento"
                name="enderecocomplemento"
              />
            </div>

            <div class="form-group mb-3">
              <label for="osLocalizacao">Localiza√ß√£o</label>
              <input
                type="text"
                class="form-control"
                id="osLocalizacao"
                name="localizacao"
              />
            </div>
          </div>

          <!-- Data -->
          <div class="form-group mb-3">
            <label for="osDate">Data</label>
            <input
              type="date"
              class="form-control"
              id="osDate"
              name="dateos"
              required
            />
          </div>

          <!-- Hora in√≠cio -->
          <div class="form-group mb-3">
            <label for="osStartTime">Hora de In√≠cio</label>
            <input
              type="time"
              class="form-control"
              id="osStartTime"
              name="start_time"
              required
            />
          </div>

          <!-- Hora fim -->
          <div class="form-group mb-3">
            <label for="osEndTime">Hora de T√©rmino</label>
            <input
              type="time"
              class="form-control"
              id="osEndTime"
              name="end_time"
              required
            />
          </div>

          <!-- T√©cnico -->
          <div class="form-group mb-3">
            <select
              class="form-select tecnico-select"
              id="osTechnician"
              name="tecnico"
            >
              <option selected value="">Selecionar T√©cnico</option>
              {% for tecnico_id, tecnico in tecnicos.items() %}
              <option value="{{ tecnico_id }}">{{ tecnico.name }}</option>
              {% endfor %}
            </select>
          </div>

          <input type="text" value="{{date}}" name="date" hidden />

          <!-- Bot√£o Confirmar -->
          <button
            type="submit"
            id="confirmaros"
            class="btn btn-primary confirmar-os-btn"
          >
            Confirmar OS
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{% else %}
<p class="text-center mt-5" style="font-size: 18px; color: #888">
  Nenhum registro de atendimento encontrado para a data selecionada.
</p>
{% endif %}

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
  // Preencher o modal √∫nico de acordo com o bot√£o clicado
  $("#osModal").on("show.bs.modal", function (event) {
    var button = $(event.relatedTarget); // bot√£o que abriu o modal
    var tipo = button.data("tipo") || "os";

    var city = button.data("city");
    var name = button.data("name");
    var phone = button.data("phone");
    var price = button.data("price");
    var servicoOriginal = button.data("service");
    var idRecord = button.data("idrecord");

    var modal = $(this);
    modal.find("#osIdRecord").val(idRecord);
    modal.find("#osCity").val(city);
    modal.find("#osName").val(name);
    modal.find("#osPhone").val(phone);
    modal.find("#osPrice").val(price);

    var servicoField = modal.find("#osServico");
    var titulo = "Gerar Ordem de Servi√ßo";
    var textoBotao = "Confirmar OS";

    if (tipo === "reparo") {
      servicoField.val("Reparo");
      textoBotao = "Confirmar OS Reparo";
    } else if (tipo === "retorno") {
      servicoField.val("Retorno");
      textoBotao = "Confirmar Retorno";
    } else {
      servicoField.val(servicoOriginal);
      textoBotao = "Confirmar OS";
    }

    modal.find("#osModalLabel").text(titulo);
    modal.find("#confirmaros").text(textoBotao);

    // limpa o valor final ao abrir
    modal.find("#osPriceFinal").val("");
  });
</script>

<script>
  function handleSwitchChange(date1, startTime1, endTime1, technician1, city1) {
    const date = date1;
    const startTime = startTime1;
    const endTime = endTime1;
    const technician = technician1;
    const city = city1;

    const data = {
      date: date,
      startTime: startTime,
      endTime: endTime,
      technician: technician,
      city: city,
    };

    console.log(data);

    fetch("/verifica_agenda", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then((response) => {
        if (response.ok) {
          document.getElementById("confirmaros").disabled = false;
          return response.json();
        } else {
          return response.json().then((errorData) => {
            throw new Error(errorData.message);
          });
        }
      })
      .then((responseData) => {
        console.log(responseData);
      })
      .catch((error) => {
        console.error("Erro ao enviar os dados:", error);
        document.getElementById("confirmaros").disabled = true;
        alert(error.message);
      });
  }

  function onFieldsChange() {
    const date = document.getElementById("osDate").value;
    const startTime = document.getElementById("osStartTime").value;
    const endTime = document.getElementById("osEndTime").value;
    const technician = document.getElementById("osTechnician").value;
    const city = document.getElementById("osCity").value;

    handleSwitchChange(date, startTime, endTime, technician, city);
  }

  document
    .getElementById("osTechnician")
    .addEventListener("change", onFieldsChange);
</script>

<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", (event) => {
    const DateTime = luxon.DateTime;
    const nowInSaoPaulo = DateTime.now().setZone("America/Sao_Paulo");
    const formattedDate = nowInSaoPaulo.toFormat("yyyy-MM-dd");
    const dateInput = document.getElementById("osDate");
    dateInput.value = formattedDate;
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    configurarFormatacaoValor("osPriceFinal");
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const selects = document.querySelectorAll(".tecnico-select");
    const botoes = document.querySelectorAll(".confirmar-os-btn");

    selects.forEach((select, index) => {
      const botao = botoes[index];
      botao.disabled = true; // desabilita inicialmente

      select.addEventListener("change", function () {
        botao.disabled = select.value === "";
      });
    });
  });
</script>

<script>
  function mascaraCep(input) {
    let v = input.value.replace(/\D/g, "");
    if (v.length > 5) {
      input.value = v.substring(0, 5) + "-" + v.substring(5, 8);
    } else {
      input.value = v;
    }
  }
</script>
<script>
  function formatarCpfCnpj(input) {
    let valor = input.value.replace(/\D/g, ""); // Remove todos os caracteres n√£o num√©ricos

    if (valor.length <= 11) {
      // Formatar como CPF: 123.456.789-09
      valor = valor.replace(/(\d{3})(\d)/, "$1.$2");
      valor = valor.replace(/(\d{3})(\d)/, "$1.$2");
      valor = valor.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
    } else if (valor.length > 11 && valor.length <= 14) {
      // Formatar como CNPJ: 112.345.678/0001-23 ou 12.345.678/0001-23
      valor = valor.replace(/(\d{3})(\d)/, "$1.$2"); // Exemplo: 112.345
      valor = valor.replace(/(\d{3})(\d)/, "$1.$2"); // Exemplo: 112.345.678
      valor = valor.replace(/(\d{3})(\d)/, "$1/$2"); // Exemplo: 112.345.678/0001
      valor = valor.replace(/(\d{4})(\d{1,2})$/, "$1-$2"); // Exemplo: 112.345.678/0001-23
    } else if (valor.length > 14) {
      // Adaptar CNPJs maiores que 14 d√≠gitos
      valor = valor.replace(/(\d{3})(\d)/, "$1.$2"); // Exemplo: 123.456
      valor = valor.replace(/(\d{3})(\d)/, "$1.$2"); // Exemplo: 123.456.789
      valor = valor.replace(/(\d{3})(\d)/, "$1/$2"); // Exemplo: 123.456.789/0012
      valor = valor.replace(/(\d{4})(\d{2})$/, "$1-$2"); // Exemplo: 123.456.789/0012-34
    }

    input.value = valor; // Atualiza o valor do campo
  }
</script>

<script>
  function buscarCep(cep) {
    cep = cep.replace(/\D/g, "");
    if (cep.length !== 8) return;

    fetch(`https://viacep.com.br/ws/${cep}/json/`)
      .then((response) => response.json())
      .then((data) => {
        if (data.erro) {
          alert("CEP n√£o encontrado!");
          return;
        }

        document.getElementById("osRua").value = data.logradouro || "";
        document.getElementById("osBairro").value = data.bairro || "";
        // Se quiser completar cidade/UF em outro campo, pode usar:
        // document.getElementById("osLocalizacao").value =
        //   (data.localidade || "") + " - " + (data.uf || "");
      })
      .catch(() => {
        alert("Erro ao consultar CEP.");
      });
  }
</script>

{% endblock %}
